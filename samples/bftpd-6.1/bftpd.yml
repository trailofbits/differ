name: bftpd
version: '6.1'
link_filename: bftpd
original: bin/bftpd.original
debloaters:
  original: bin/bftpd.original

templates:
  # Get a file
  - name: get
    summary: Download a file using the 'RETR' command.
    arguments: '-D -c default-anon.conf'
    input_files:
      - default-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        get myfile.txt
        EOF

        cmp myfile.txt ./serve/myfile.txt

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 0
      - id: file
        filename: myfile.txt
        target: serve/myfile.txt
      - id: file
        filename: myfile.txt

  # Navigate (cd, ls)
  - name: navigation
    summary: Navigate an FTP share using the 'CWD', 'CDUP',  and 'LIST' commands.
    arguments: '-D -c default-anon.conf'
    input_files:
      - default-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        ls
        cd child
        ls
        cd ..
        ls
        EOF

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 0

  # chmod
  - name: chmod
    summary: Modify an existing file's mode using the 'MFF' command.
    arguments: '-D -c default-anon.conf'
    input_files:
      - default-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        chmod 440 myfile.txt
        EOF

    comparators:
      - stdout
      - id: concurrent_script
        exit_code:
          expect: 0
      - id: file
        filename: serve/myfile.txt
        mode: 440

  # put
  - name: put
    summary: Upload a file using the 'STOR' command.
    arguments: '-D -c default-anon.conf'
    input_files:
      - default-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    setup: |
      echo hello world > file

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        put file
        EOF

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 0
      - id: file
        filename: serve/file
        target: file
      - id: file
        filename: file

  # mkdir
  - name: mkdir
    summary: Make a new directory using the 'MKD' command.
    arguments: '-D -c default-anon.conf'
    input_files:
      - default-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        mkdir second
        EOF

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 0
      - id: file
        filename: serve/second
        type: directory

  # mv
  - name: mv
    summary: Rename a file using the 'RNFR' and 'RNTO' commands.
    arguments: '-D -c default-anon.conf'
    input_files:
      - default-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    setup: |
      cp serve/myfile.txt myfile_original.txt

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        mv myfile.txt myfile2.txt
        EOF

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 0
      - id: file
        filename: serve/myfile2.txt
        target: myfile_original.txt
      - id: file
        filename: serve/myfile2.txt
      - id: file
        filename: serve/myfile.txt
        exists: false

  # pwd
  - name: pwd
    summary: Get the working directory using the 'PWD' command.
    arguments: '-D -c default-anon.conf'
    input_files:
      - default-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        cd ..
        cd ..
        pwd
        EOF

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 0

  # rm
  - name: rm
    summary: Remove a file using the 'DELE' command.
    arguments: '-D -c default-anon.conf'
    input_files:
      - default-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        rm myfile.txt
        EOF

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 0
      - id: file
        filename: serve/myfile.txt
        exists: false

  # rmdir
  - name: rmdir
    summary: Delete a directory tree using the 'RMD' command.
    arguments: '-D -c default-anon.conf'
    input_files:
      - default-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    setup: |
      mkdir serve/delete_me

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        rmdir delete_me
        EOF

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 0
      - id: file
        filename: serve/delete_me
        exists: false

  #####################
  # Disabled Commands #
  #####################
  # rm
  - name: rm_disabled
    summary: >
      Attempt to delete a file using the 'DELE' command but fail because the command is unallowed
      in the bftpd configuration.
    arguments: '-D -c disabled-cmds-anon.conf'
    input_files:
      - disabled-cmds-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        rm myfile.txt
        EOF

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 1
      - id: file
        filename: serve/myfile.txt

  # rmdir
  - name: rmdir_disabled
    summary: >
      Attempt to delete a directory using the 'RMD' command but fail because the command is
      unallowed in the bftpd configuration.
    arguments: '-D -c disabled-cmds-anon.conf'
    input_files:
      - disabled-cmds-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    setup: |
      mkdir serve/delete_me

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        rmdir delete_me
        EOF

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 1
      - id: file
        filename: serve/delete_me
        type: directory

  # chmod
  - name: chmod_disabled
    summary: >
      Attempt to modify a file's mode using the 'MFF' command but fail because the command is
      unallowed in the bftpd configuration.
    arguments: '-D -c disabled-cmds-anon.conf'
    input_files:
      - disabled-cmds-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    setup: |
      chmod 664 serve/myfile.txt

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        chmod 440 myfile.txt
        EOF

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 1
      - id: file
        filename: serve/myfile.txt
        mode: 664

  # put
  - name: put_disabled
    summary: >
      Attempt to upload a file using the 'STOR' command but fail because the command is
      unallowed in the bftpd configuration.
    arguments: '-D -c disabled-cmds-anon.conf'
    input_files:
      - disabled-cmds-anon.conf
      - source: lftp.rc
        static: true
      - source: serve
        static: true

    setup: |
      echo hello world > file

    concurrent:
      mode: client
      run: |
        lftp --rcfile lftp.rc <<EOF
        put file
        EOF

    comparators:
      - stdout
      - stderr
      - exit_code
      - id: concurrent_script
        exit_code:
          expect: 1
      - id: file
        filename: serve/file
        exists: false
